<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="C·ª≠a h√†ng game tr·ª±c tuy·∫øn v·ªõi c√°c s·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng cho game th·ªß">
    <title>Store - C·ª≠a h√†ng game</title>
    <link rel="stylesheet" href="../css/store.css">
    <link rel="icon" type="image/png" sizes="96x96" href="../../Home/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../../Home/favicon/web-app-manifest-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../../Home/favicon/web-app-manifest-512x512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../../Home/favicon/apple-touch-icon.png">
    <link rel="manifest" href="../../Home/favicon/site.webmanifest">
</head>
<body>
    <header>
        <div class="header-container">
            <a href="../../Home/home/home.html">
                <img src="../../Home/img/logo.png" alt="Logo" class="logo">
            </a>
            <h1>Game Store</h1>
            <div class="cart-icon" onclick="openCart()">
                üõí <span id="cart-count">0</span>
            </div>
            <div class="menu-icon">‚ò∞</div>
        </div>
    </header>
    
    <main>
        <section class="products" id="product-list">
            <div class="loading">ƒêang t·∫£i s·∫£n ph·∫©m...</div>
        </section>
        <div id="cart-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>X√°c nh·∫≠n mua h√†ng</h2>
                <p id="cart-details"></p>
                <button onclick="confirmPurchase()">Thanh to√°n</button>
            </div>
        </div>
        <!-- Th√™m modal gi·ªè h√†ng -->
        <div id="shopping-cart-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeCartModal()">&times;</span>
                <h2>Gi·ªè h√†ng</h2>
                <div id="cart-items"></div>
                <div id="cart-total"></div>
                <button onclick="checkout()" id="checkout-button">Thanh to√°n t·∫•t c·∫£</button>
            </div>
        </div>
    </main>
    
    <script src="../../config/api.js"></script>
    <script>
        let cart = [];
        let products = [];

        // Add functions for handling modals
        function closeCartModal() {
            document.getElementById("shopping-cart-modal").style.display = "none";
        }

        function closeModal() {
            document.getElementById("cart-modal").style.display = "none";
        }

        // Add showError function to global scope
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            document.body.insertBefore(errorDiv, document.body.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }

        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById("cart-count").textContent = count;
        }

        function openCart() {
            const cartItems = document.getElementById("cart-items");
            const cartTotal = document.getElementById("cart-total");
            let total = 0;

            cartItems.innerHTML = cart.map(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                return `
                    <div class="cart-item">
                        <span>${item.name}</span>
                        <span>${item.quantity} x ${item.price.toLocaleString("vi-VN")} VNƒê</span>
                        <span>${subtotal.toLocaleString("vi-VN")} VNƒê</span>
                        <div class="cart-item-controls">
                            <input type="number" 
                                   value="${item.quantity}" 
                                   min="1" 
                                   max="${products.find(p => p.id.toString() === item.productId).stock}"
                                   onchange="updateItemQuantity('${item.productId}', this.value)">
                            <button onclick="removeFromCart('${item.productId}')">X√≥a</button>
                        </div>
                    </div>
                `;
            }).join("");

            cartTotal.innerHTML = `T·ªïng c·ªông: ${total.toLocaleString("vi-VN")} VNƒê`;
            document.getElementById("shopping-cart-modal").style.display = "flex";
            document.getElementById("checkout-button").disabled = cart.length === 0;
        }

        // Th√™m h√†m m·ªõi ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng trong gi·ªè h√†ng
        function updateItemQuantity(productId, newQuantity) {
            const item = cart.find(item => item.productId === productId);
            const product = products.find(p => p.id.toString() === productId);
            
            newQuantity = parseInt(newQuantity);
            
            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }
            
            if (newQuantity > product.stock) {
                showError('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° h√†ng t·ªìn kho!');
                openCart(); // Refresh cart display
                return;
            }
            
            item.quantity = newQuantity;
            item.total = item.price * newQuantity;
            
            updateCartCount();
            openCart(); // Refresh cart display
        }

        function addToCart(button) {
            const productDiv = button.parentElement.parentElement; // Th√™m .parentElement v√¨ c√≥ th√™m div container
            const quantityInput = productDiv.querySelector(".quantity");
            const quantity = parseInt(quantityInput.value);
            const productId = quantityInput.dataset.id;
            const name = quantityInput.dataset.name;
            const price = parseFloat(quantityInput.dataset.price); // ƒê·ªïi sang parseFloat ƒë·ªÉ x·ª≠ l√Ω s·ªë th·∫≠p ph√¢n
            
            // Ki·ªÉm tra s·ªë l∆∞·ª£ng t·ªìn kho
            const product = products.find(p => p.id.toString() === productId);
            if (product.stock < quantity) {
                showError('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° h√†ng t·ªìn kho!');
                return;
            }

            // Ki·ªÉm tra xem s·∫£n ph·∫©m ƒë√£ c√≥ trong gi·ªè h√†ng ch∆∞a
            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                if (existingItem.quantity + quantity > product.stock) {
                    showError('S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° h√†ng t·ªìn kho!');
                    return;
                }
                existingItem.quantity += quantity;
            } else {
                cart.push({ 
                    productId, 
                    quantity, 
                    name, 
                    price,
                    total: price * quantity // Th√™m t·ªïng ti·ªÅn cho m·ªói item
                });
            }

            updateCartCount();
            showError(`ƒê√£ th√™m ${quantity} ${name} v√†o gi·ªè h√†ng!`);
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.productId !== productId);
            updateCartCount();
            openCart(); // C·∫≠p nh·∫≠t l·∫°i hi·ªÉn th·ªã gi·ªè h√†ng
        }

        async function checkout() {
            try {
                const orderData = {
                    items: cart,
                    total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                };
                
                const order = await API.store.createOrder(orderData);
                
                if (order.success) {
                    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng t·ªìn kho v√† hi·ªÉn th·ªã t·ª´ng s·∫£n ph·∫©m
                    for (const product of products) {
                        const orderedItem = cart.find(item => item.productId === product.id.toString());
                        if (orderedItem) {
                            product.stock -= orderedItem.quantity;
                            updateProductDisplay(product); // C·∫≠p nh·∫≠t hi·ªÉn th·ªã cho t·ª´ng s·∫£n ph·∫©m
                        }
                    }

                    alert("Thanh to√°n th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng.");
                    cart = [];
                    updateCartCount();
                    closeCartModal();
                } else {
                    showError('Thanh to√°n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            } catch (error) {
                showError('C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh thanh to√°n');
            }
        }

        // Th√™m h√†m m·ªõi ƒë·ªÉ c·∫≠p nh·∫≠t hi·ªÉn th·ªã s·∫£n ph·∫©m
        function updateProductDisplay(product) {
            // T√¨m ph·∫ßn t·ª≠ s·∫£n ph·∫©m d·ª±a tr√™n ID
            const productElement = document.querySelector(`.product input[data-id="${product.id}"]`).closest('.product');
            if (!productElement) return;

            const addToCartBtn = productElement.querySelector('.add-to-cart-button');
            const buyNowBtn = productElement.querySelector('.buy-button');
            const quantityInput = productElement.querySelector('.quantity');
            const stockDisplay = productElement.querySelector('.stock-status') || 
                               createStockDisplay(productElement);

            if (product.stock <= 0) {
                addToCartBtn.disabled = true;
                buyNowBtn.disabled = true;
                addToCartBtn.textContent = 'H·∫øt h√†ng';
                buyNowBtn.textContent = 'H·∫øt h√†ng';
                quantityInput.disabled = true;
                stockDisplay.textContent = 'H·∫øt h√†ng';
                stockDisplay.className = 'stock-status out-of-stock';
                productElement.classList.add('product-out-of-stock');
            } else {
                addToCartBtn.disabled = false;
                buyNowBtn.disabled = false;
                addToCartBtn.textContent = 'Th√™m v√†o gi·ªè';
                buyNowBtn.textContent = 'Mua ngay';
                quantityInput.disabled = false;
                quantityInput.max = product.stock;
                stockDisplay.textContent = `C√≤n ${product.stock} s·∫£n ph·∫©m`;
                stockDisplay.className = 'stock-status in-stock';
                productElement.classList.remove('product-out-of-stock');
            }
        }

        function createStockDisplay(productElement) {
            const stockDisplay = document.createElement('div');
            stockDisplay.className = 'stock-status';
            // Th√™m v√†o sau ph·∫ßn gi√°
            const priceElement = productElement.querySelector('.price');
            priceElement.parentNode.insertBefore(stockDisplay, priceElement.nextSibling);
            return stockDisplay;
        }

        async function confirmPurchase() {
            try {
                const orderData = {
                    items: cart,
                    total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                };
                
                const order = await API.store.createOrder(orderData);
                
                if (order.success) {
                    alert("Thanh to√°n th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng.");
                    closeModal();
                    loadProducts(); // Reload products to update stock
                } else {
                    showError('Thanh to√°n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            } catch (error) {
                showError('C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh thanh to√°n');
            }
        }

        function buyNow(button) {
            addToCart(button);
            openCart();
        }

        document.addEventListener("DOMContentLoaded", function() {
            // Check authentication
            if (!API.auth.isAuthenticated()) {
                window.location.href = '../../Login-Register/Login/login.html';
                return;
            }

            async function loadProducts() {
                try {
                    const productList = document.getElementById("product-list");
                    if (!productList) {
                        console.error("Product list element not found");
                        return;
                    }

                    products = await API.store.getProducts();
                    if (!products || products.length === 0) {
                        productList.innerHTML = '<div class="no-products">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o</div>';
                        return;
                    }

                    productList.innerHTML = products.map(product => `
                        <div class="product">
                            <img src="../img/${product.image}" alt="${product.name}">
                            <h2>${product.name}</h2>
                            <p>${product.description}</p>
                            <p class="price">Gi√°: ${product.price.toLocaleString("vi-VN")} VNƒê</p>
                            <input type="number" min="1" max="${product.stock}" value="1" class="quantity" 
                                   data-id="${product.id}" data-name="${product.name}" data-price="${product.price}">
                            <div class="button-container" style="display: flex; gap: 10px; justify-content: center;">
                                <button class="add-to-cart-button" onclick="addToCart(this)" ${product.stock <= 0 ? 'disabled' : ''}>
                                    ${product.stock <= 0 ? 'H·∫øt h√†ng' : 'Th√™m v√†o gi·ªè'}
                                </button>
                                <button class="buy-button" onclick="buyNow(this)" ${product.stock <= 0 ? 'disabled' : ''}>
                                    ${product.stock <= 0 ? 'H·∫øt h√†ng' : 'Mua ngay'}
                                </button>
                            </div>
                        </div>
                    `).join("");
                } catch (error) {
                    console.error('Error loading products:', error);
                    const productList = document.getElementById("product-list");
                    if (productList) {
                        productList.innerHTML = '<div class="error">Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m</div>';
                    }
                }
            }

            // Load products when DOM is ready
            loadProducts();

            function toggleMenu() {
                document.getElementById("mobile-menu").classList.toggle("show");
            }
        });
    </script>
</body>
</html>